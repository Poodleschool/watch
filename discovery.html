<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pooxie Watch Discover</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(180deg, #0f0c29, #302b63, #24243e);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: white;
      overflow-x: hidden;
    }

    header {
      padding: 20px;
      text-align: center;
      font-size: 2em;
      background: rgba(0, 0, 0, 0.4);
      font-weight: bold;
    }

    .search-bar {
      text-align: center;
      margin: 20px;
    }

    .search-bar input {
      width: 60%;
      padding: 10px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: scale(1.05);
    }

    .card img {
      width: 100%;
      aspect-ratio: 2 / 3;
      object-fit: cover;
    }

    .card-content {
      padding: 10px;
    }

    .card-content h3 {
      font-size: 1.1em;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-content p {
      font-size: 0.9em;
      color: #ccc;
      margin-top: 8px;
      max-height: 80px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }

    .card-content button {
      margin-top: 10px;
      padding: 10px;
      border: none;
      border-radius: 10px;
      background-color: #ff66cc;
      color: white;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      transition: all 0.3s ease;
    }

    .card-content button:hover {
      background-color: #ff85d8;
    }

    .category-section {
      margin: 30px 20px 10px;
    }

    .category-title {
      font-size: 1.5em;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 2px solid #ff66cc;
      display: inline-block;
    }

    .category-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 0 20px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .category-tabs::-webkit-scrollbar {
      display: none;
    }

    .category-tab {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s ease;
    }

    .category-tab:hover, .category-tab.active {
      background: #ff66cc;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #302b63;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-size: 1.2em;
      color: #ff66cc;
    }
  </style>
</head>
<body>
  <header>ðŸŽ¬ Pooxie Watch</header>
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search movies or TV shows...">
  </div>

  <div class="category-tabs" id="categoryTabs">
    <div class="category-tab active" data-category="popular">Popular</div>
    <div class="category-tab" data-category="trending">Trending</div>
    <div class="category-tab" data-category="top_rated">Top Rated</div>
    <div class="category-tab" data-category="action">Action</div>
    <div class="category-tab" data-category="comedy">Comedy</div>
    <div class="category-tab" data-category="sci_fi">Sci-Fi</div>
    <div class="category-tab" data-category="drama">Drama</div>
    <div class="category-tab" data-category="animation">Animation</div>
  </div>

  <div class="category-section">
    <div class="category-title" id="currentCategory">Popular</div>
    <div class="grid" id="results"></div>
    <div class="loading" id="loadingIndicator" style="display: none;">Loading more content...</div>
  </div>

  <!-- Modal for TV show season/episode selection -->
  <div class="modal" id="tvModal">
    <div class="modal-content">
      <div class="modal-title" id="modalTitle">Select Season and Episode</div>
      <div class="season-select">
        <label for="seasonSelect">Season:</label>
        <select id="seasonSelect"></select>
      </div>
      <div class="episode-select">
        <label for="episodeSelect">Episode:</label>
        <select id="episodeSelect"></select>
      </div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="cancelBtn">Cancel</button>
        <button class="play-btn" id="confirmPlayBtn">Play</button>
      </div>
    </div>
  </div>

  <script>
    const API_KEY = '95266f5bb551bf1ae4078c918c7185e4';
    const BASE_URL = 'https://api.themoviedb.org/3';
    const IMG_BASE = 'https://image.tmdb.org/t/p/w500';

    // DOM Elements
    const resultsContainer = document.getElementById('results');
    const searchInput = document.getElementById('searchInput');
    const categoryTabs = document.getElementById('categoryTabs');
    const currentCategoryTitle = document.getElementById('currentCategory');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const tvModal = document.getElementById('tvModal');

    // State management
    let currentPage = 1;
    let currentCategory = 'popular';
    let isLoading = false;
    let hasMoreContent = true;
    let currentSearchQuery = '';
    let currentTvShow = {
      id: null,
      title: null,
      seasons: []
    };

    // Genre IDs mapping (no duplicates)
    const GENRE_IDS = {
      action: 28,
      comedy: 35,
      sci_fi: 878,
      drama: 18,
      animation: 16
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      fetchContent(currentCategory);
      setupInfiniteScroll();
    });

    // Infinite scroll setup
    function setupInfiniteScroll() {
      window.addEventListener('scroll', () => {
        if (isLoading || !hasMoreContent) return;
        
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
        if (scrollTop + clientHeight >= scrollHeight - 500) {
          loadMoreContent();
        }
      });
    }

    async function loadMoreContent() {
      if (isLoading) return;
      
      isLoading = true;
      loadingIndicator.style.display = 'block';
      currentPage++;
      
      try {
        if (currentSearchQuery) {
          await search(currentSearchQuery, currentPage);
        } else {
          await fetchContent(currentCategory, currentPage);
        }
      } finally {
        isLoading = false;
        loadingIndicator.style.display = 'none';
      }
    }

    async function fetchContent(category, page = 1) {
      currentCategory = category;
      currentPage = page;
      
      let movies = [], tv = [];
      
      try {
        switch(category) {
          case 'popular':
            [movies, tv] = await Promise.all([
              fetch(`${BASE_URL}/movie/popular?api_key=${API_KEY}&page=${page}`).then(r => r.json()),
              fetch(`${BASE_URL}/tv/popular?api_key=${API_KEY}&page=${page}`).then(r => r.json())
            ]);
            break;
          case 'trending':
            [movies, tv] = await Promise.all([
              fetch(`${BASE_URL}/trending/movie/day?api_key=${API_KEY}&page=${page}`).then(r => r.json()),
              fetch(`${BASE_URL}/trending/tv/day?api_key=${API_KEY}&page=${page}`).then(r => r.json())
            ]);
            break;
          case 'top_rated':
            [movies, tv] = await Promise.all([
              fetch(`${BASE_URL}/movie/top_rated?api_key=${API_KEY}&page=${page}`).then(r => r.json()),
              fetch(`${BASE_URL}/tv/top_rated?api_key=${API_KEY}&page=${page}`).then(r => r.json())
            ]);
            break;
          default:
            if (GENRE_IDS[category]) {
              [movies, tv] = await Promise.all([
                fetch(`${BASE_URL}/discover/movie?api_key=${API_KEY}&with_genres=${GENRE_IDS[category]}&page=${page}`).then(r => r.json()),
                fetch(`${BASE_URL}/discover/tv?api_key=${API_KEY}&with_genres=${GENRE_IDS[category]}&page=${page}`).then(r => r.json())
              ]);
            }
        }

        // Combine results with TV shows first
        const combinedResults = [...tv.results, ...movies.results];
        
        if (page === 1) {
          resultsContainer.innerHTML = '';
          hasMoreContent = true;
        }
        
        displayResults(combinedResults);
        
        // Check if we've reached the end
        if (page >= (movies.total_pages || tv.total_pages)) {
          hasMoreContent = false;
        }
      } catch (error) {
        console.error('Error fetching content:', error);
      }
    }

    async function search(query, page = 1) {
      currentSearchQuery = query;
      
      if (query.length < 3) {
        if (query.length === 0) {
          currentSearchQuery = '';
          fetchContent(currentCategory);
        }
        return;
      }

      try {
        const [movieSearch, tvSearch] = await Promise.all([
          fetch(`${BASE_URL}/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(query)}&page=${page}`).then(r => r.json()),
          fetch(`${BASE_URL}/search/tv?api_key=${API_KEY}&query=${encodeURIComponent(query)}&page=${page}`).then(r => r.json())
        ]);

        // Combine results with TV shows first
        const combinedResults = [...tvSearch.results, ...movieSearch.results];
        
        if (page === 1) {
          resultsContainer.innerHTML = '';
          hasMoreContent = true;
        }
        
        displayResults(combinedResults);
        
        // Check if we've reached the end
        if (page >= (movieSearch.total_pages || tvSearch.total_pages)) {
          hasMoreContent = false;
        }
      } catch (error) {
        console.error('Error searching:', error);
      }
    }

    function displayResults(items) {
      if (!items || items.length === 0) {
        if (currentPage === 1) {
          resultsContainer.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No results found</p>';
        }
        return;
      }

      items.forEach(item => {
        const isTV = item.hasOwnProperty('first_air_date');
        const id = item.id;
        const title = isTV ? item.name : item.title;
        const overview = item.overview || "No description available.";
        const poster = item.poster_path ? `${IMG_BASE}${item.poster_path}` : 'https://via.placeholder.com/500x750?text=No+Image';
        const type = isTV ? 'tv' : 'movie';

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${poster}" alt="${title}" loading="lazy" />
          <div class="card-content">
            <h3>${title}</h3>
            <p>${overview}</p>
            <button onclick="handlePlayClick('${type}', ${id}, '${title.replace(/'/g, "\\'")}')">â–¶ Play</button>
          </div>
        `;
        resultsContainer.appendChild(card);
      });
    }

    // TV Show Modal Functions
    async function showSeasonSelection(tvId) {
      try {
        const response = await fetch(`${BASE_URL}/tv/${tvId}?api_key=${API_KEY}`);
        const tvDetails = await response.json();
        
        currentTvShow = {
          id: tvId,
          title: tvDetails.name,
          seasons: tvDetails.seasons.filter(season => season.season_number > 0)
        };
        
        // Populate season select
        seasonSelect.innerHTML = '';
        currentTvShow.seasons.forEach(season => {
          const option = document.createElement('option');
          option.value = season.season_number;
          option.textContent = `Season ${season.season_number}`;
          seasonSelect.appendChild(option);
        });
        
        // Load episodes for first season
        await loadEpisodesForSeason(currentTvShow.id, currentTvShow.seasons[0].season_number);
        tvModal.style.display = 'flex';
      } catch (error) {
        console.error('Error loading seasons:', error);
      }
    }

    async function loadEpisodesForSeason(tvId, seasonNumber) {
      try {
        const response = await fetch(`${BASE_URL}/tv/${tvId}/season/${seasonNumber}?api_key=${API_KEY}`);
        const seasonDetails = await response.json();
        
        episodeSelect.innerHTML = '';
        seasonDetails.episodes.forEach(episode => {
          const option = document.createElement('option');
          option.value = episode.episode_number;
          option.textContent = `Episode ${episode.episode_number}: ${episode.name}`;
          episodeSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading episodes:', error);
      }
    }

    // Event Handlers
    function handlePlayClick(type, id, title) {
      if (type === 'tv') {
        showSeasonSelection(id);
      } else {
        play(type, id);
      }
    }

    function play(type, id, season = null, episode = null) {
      let url = `watch.html?type=${type}&id=${id}`;
      if (type === 'tv' && season !== null && episode !== null) {
        url += `&season=${season}&episode=${episode}`;
      }
      window.location.href = url;
    }

    categoryTabs.addEventListener('click', (e) => {
      if (e.target.classList.contains('category-tab')) {
        document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
        e.target.classList.add('active');
        
        const category = e.target.dataset.category;
        currentCategoryTitle.textContent = e.target.textContent;
        fetchContent(category);
      }
    });

    searchInput.addEventListener('input', () => {
      const query = searchInput.value.trim();
      currentSearchQuery = query;
      
      if (query.length > 2) {
        search(query);
      } else if (query.length === 0) {
        fetchContent(currentCategory);
      }
    });

    // Modal event listeners
    seasonSelect.addEventListener('change', async () => {
      const seasonNumber = parseInt(seasonSelect.value);
      await loadEpisodesForSeason(currentTvShow.id, seasonNumber);
    });

    confirmPlayBtn.addEventListener('click', () => {
      const season = parseInt(seasonSelect.value);
      const episode = parseInt(episodeSelect.value);
      tvModal.style.display = 'none';
      play('tv', currentTvShow.id, season, episode);
    });

    cancelBtn.addEventListener('click', () => {
      tvModal.style.display = 'none';
    });
  </script>
</body>
</html>
